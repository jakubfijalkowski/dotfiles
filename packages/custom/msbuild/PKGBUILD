pkgname=msbuild
pkgver=16.3+xamarinxplat.2019.08.08.00.55
pkgrel=10
pkgdesc='Build system for .NET and Visual Studio'
arch=('any')
url='https://github.com/mono/msbuild'
license=('MIT')
depends=('mono>=6.0.0')
optdepends=('dotnet-host: .NET Core support' 'dotnet-sdk: .NET Core support')
makedepends=('dotnet-host' 'unzip')
provides=("msbuild-sdkresolver=${pkgver}")
conflicts=('msbuild-sdkresolver')
source=("https://download.mono-project.com/sources/msbuild/msbuild-${pkgver}.tar.xz")
sha256sums=('SKIP')

prepare()
{
    cd "${srcdir}/msbuild-${pkgver%+*}"

    ln -f LICENSE license
    rm -f mono/SdkResolvers/Microsoft.DotNet.MSBuildSdkResolver/libhostfxr.dylib

    patch -Np1 <<'EOF'
diff --git a/mono/build/install.proj b/mono/build/install.proj
index d202ffb..b8a1795 100644
--- a/mono/build/install.proj
+++ b/mono/build/install.proj
@@ -31,7 +31,6 @@
         <ItemGroup>
             <MSBuildFiles Include="$(MSBuildBinSrcDir)\Microsoft.Build.*" />
             <MSBuildFiles Include="$(MSBuildBinSrcDir)\MSBuild.dll*" />
-            <MSBuildFiles Include="$(MSBuildBinSrcDir)\MSBuild.pdb" />
             <MSBuildFiles Include="$(MSBuildBinSrcDir)\MSBuild.rsp" />

             <MSBuildFiles Include="$(MSBuildBinSrcDir)\Microsoft.*props" />
@@ -160,7 +159,7 @@
             <CopiedFiles Include="$(MSBuildInstallBinDir)\System.Reflection.Metadata.dll" />
         </ItemGroup>

-        <Exec Command="$(RepoRoot)\mono\build\gen_msbuild_wrapper.sh $(MonoInstallPrefix) $(MonoInstallPrefix)\bin" />
+        <Exec Command="$(RepoRoot)\mono\build\gen_msbuild_wrapper.sh /usr $(MonoInstallPrefix)\bin" />
         <ItemGroup>
             <CopiedFiles Include="$(MonoInstallPrefix)\bin\msbuild" />
         </ItemGroup>
EOF
}

build()
{
    cd "${srcdir}/msbuild-${pkgver%+*}"

    ./eng/cibuild_bootstrapped_msbuild.sh \
        --host_type mono \
        --configuration Release \
        --skip_tests \
        /p:DebugSymbols=false \
        /p:DebugType=none
}

package()
{
    cd "${srcdir}/msbuild-${pkgver%+*}"

    ./stage1/mono-msbuild/msbuild \
        /p:MonoInstallPrefix="${pkgdir}/usr" \
        /p:Configuration=Release-MONO \
        /p:TargetMSBuildToolsVersion=Current \
        mono/build/install.proj

    install -Dm644 LICENSE "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
}
